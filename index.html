<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Pastebin</title>
    <link rel="stylesheet" href="style.css">
</head>

<!-- Works with ws-node in this repo -->

<body>
    <input id="in" type="text" placeholder="Paste here">
    <p id="out">...</p>
    <div id="conn_status">Not connected</div>
    <p id="err" style="color: red;"></p>

    <details>
        <summary>Settings</summary>
        <br>
        <label for="wstoken">WebSocket token</label>
        <input required id="wst" type="text" placeholder="Enter websocket token" name="wstoken">
        <br>
        <label for="wsURL">WebSocket URL</label>
        <input required id="wsUrl" type="text" placeholder="Enter websocket URL" name="wsURL">
        <button type="submit" id="btn" onclick="setKey()">Save</button>
    </details>

    <div class="note-container">
        <div id="note1" class="notes" onmousedown="dragElement(this)">
            <!--<p ondblclick="editNote(this)">Hihi</p>-->
            <textarea cols="11" rows="6" ondblclick="editNote(this)"></textarea>
        </div>

        <div id="note2" class="notes" onmousedown="dragElement(this)">
            <p ondblclick="editNote(this)">ojdå</p>
        </div>
    </div>
    <script>
        //const sleep = (delay) => new Promise((resolve) => setTimeout(resolve, delay))
        JWT_TOKEN = localStorage.getItem('jwt_token')

        function webSocket() {
            document.querySelector('#conn_status').innerHTML = "Connecting..."
            console.log("connecting...")
            // Create a WebSocket connection
            const socket = new WebSocket("ws://localhost:8080?access_token=" + localStorage.getItem("jwt_token") + "&boardId=1"); //`ws://localhost:8080?token=${WS_TOKEN}`

            // Connection established 
            socket.onopen = function (event) {
                ///console.log('ON open message:', event.data);
                //const data = JSON.parse(event.data);
                console.log('Connected to WebSocket server');
                //document.querySelector('#conn_status').innerHTML = `${data.connClients} connected`;
            };

            // Message listener
            socket.onmessage = function (event) {
                console.log('Received message:', event.data);
                const data = JSON.parse(event.data);

                if (data.status == 0) {
                    document.querySelector('#out').innerHTML = (data.msg == "") ? document.querySelector('#out').innerHTML : data.msg;
                    document.querySelector('#err').innerHTML = '';
                    document.querySelector('#conn_status').innerHTML = `${data.connClients} connected`
                } else {
                    document.querySelector('#err').innerHTML = data.msg;
                }

            };

            // Connection closed 
            socket.onclose = function (event) {
                console.log('Connection closed');
                document.querySelector('#conn_status').innerHTML = "Connection closed <button type='button' onClick=webSocket()>Reconnect</button>";
            };

            document.querySelector('#in').addEventListener('input', (evt) => {
                socket.send(evt.target.value);
            });

            return socket
        }


        function setKey() {
            let token = document.querySelector('#wst').value;
            let url = document.querySelector('#wsUrl').value;
            localStorage.setItem('ws_token', token);
            localStorage.setItem('ws_url', url);
            window.location.reload()
        }

        //flytta på element (source: w3schools tutorial)
        function dragElement(elem) {
            var diffX = 0, diffY = 0, mouseOrigX = 0, mouseOrigY = 0;
            elem.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                console.log("func dragMouseDown")
                e = e || window.event;
                e.preventDefault();
                
                //musposition när man först trycker på noten
                mouseOrigX = e.clientX;
                mouseOrigY = e.clientY;
                
                //musläpp --> sluta
                document.onmouseup = closeDragElement;

                //Musflytt --> flytta på elementet
                document.onmousemove = elementDrag;
            }

            function elementDrag(evt) {
                console.log("func elementDrag")
                evt = evt || window.event;
                evt.preventDefault();
               
                //räkna skillnaden mellan föregående och nuvarande musposition
                diffX = mouseOrigX - evt.clientX;
                diffY = mouseOrigY - evt.clientY;
                mouseOrigX = evt.clientX;
                mouseOrigY = evt.clientY;

                //räkna nya positionen till elementet
                elem.style.top = (elem.offsetTop - diffY) + "px";
                elem.style.left = (elem.offsetLeft - diffX) + "px";

                //sicka härifrån note positionen till ws
            }

            function closeDragElement() {
                //sluta allt när musen släpps
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function editNote(elem){
            console.log("double click")
            elem.contentEditable = true
            elem.focus()
        }
        
        webSocket()
    </script>

</body>

</html>
