<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Pastebin</title>
    <link rel="stylesheet" href="style.css">
</head>

<!-- Works with ws-node in this repo -->

<body>
    <input id="in" type="text" placeholder="Paste here">
    <p id="out">...</p>
    <div id="conn_status">Not connected</div>
    <p id="err" style="color: red;"></p>

    <details>
        <summary>Settings</summary>
        <br>
        <label for="wstoken">WebSocket token</label>
        <input required id="wst" type="text" placeholder="Enter websocket token" name="wstoken">
        <br>
        <label for="wsURL">WebSocket URL</label>
        <input required id="wsUrl" type="text" placeholder="Enter websocket URL" name="wsURL">
        <button type="submit" id="btn" onclick="setKey()">Save</button>
    </details>

    <button type="button" id="addNote" onclick="addNote(this)">+ new note</button>

    <div class="note-container">
        <div id="note1" class="notes" onmousedown="dragElement(this)">
            <!--<p ondblclick="editNote(this)">Hihi</p>-->
            <div id="content1" class="note_content" ondblclick="editNote(this)">hihi</div>
        </div>

        <div id="note2" class="notes" onmousedown="dragElement(this)">
            <div id="content2" class="note_content" ondblclick="editNote(this)">ojdå</div>
        </div>
    </div>
    <script>
        /**
         * "enum" för typer av event som kan ske som sickas till ws
         */
        const Events = Object.freeze({
            Connection: "Connection", //ny ws client, denna sickas främst från servern
            Move: "Move", //Noten flyttades
            Content: "Content", //Innehållet ändrade
            Add: "Add" //ny note
        })

        JWT_TOKEN = localStorage.getItem('jwt_token')

        function webSocket() {
            document.querySelector('#conn_status').innerHTML = "Connecting..."
            console.log("connecting...")
            // Create a WebSocket connection
            const socket = new WebSocket("ws://localhost:8080?access_token=" + localStorage.getItem("jwt_token") + "&boardId=1"); //`ws://localhost:8080?token=${WS_TOKEN}`

            // Connection established 
            socket.onopen = function (event) {
                ///console.log('ON open message:', event.data);
                //const data = JSON.parse(event.data);
                console.log('Connected to WebSocket server');
                //document.querySelector('#conn_status').innerHTML = `${data.connClients} connected`;
            };

            // Message listener
            socket.onmessage = function (event) {
                console.log('Received message:', event.data);
                const data = JSON.parse(event.data);

                if (data.status == 0) {
                    document.querySelector('#out').innerHTML = (data.msg == "") ? document.querySelector('#out').innerHTML : data.msg;
                    document.querySelector('#err').innerHTML = '';

                    switch (data.event) {
                        case Events.Connection: {
                            document.querySelector('#conn_status').innerHTML = `${data.connClients} connected`
                            break
                        }

                        case Events.Move: {
                            elem = document.querySelector(`#${data.elemId}`)
                            elem.style.top = data.top
                            elem.style.left = data.left
                            break
                        }
                        
                        case Events.Content: {
                            elem = document.querySelector(`#${data.elemId}`)
                            elem.innerText = data.value
                            break
                        }

                        case Events.Add: {
                            document.querySelector(".note-container").innerHTML += `<div id="${data.elemId}" class="notes" onmousedown="dragElement(this)">
                            <p id="content${data.noteCount}" ondblclick="editNote(this)"></p> </div>`

                            newNote = document.querySelector(`#${data.elemId}`)

                            newNote.style.top = '50%'
                            newNote.style.left = '50%'
                            newNote.style.transform = newNote.style.translate('50%', '50%')
                        }

                        default:
                            break
                    }
                } else {
                    document.querySelector('#err').innerHTML = data.msg;
                }

            };

            // Connection closed 
            socket.onclose = function (event) {
                console.log('Connection closed');
                document.querySelector('#conn_status').innerHTML = "Connection closed <button type='button' onClick=webSocket()>Reconnect</button>";
            };

            document.querySelector('#in').addEventListener('input', (evt) => {
                socket.send(evt.target.value);
            });

            return socket
        }


        function setKey() {
            let token = document.querySelector('#wst').value;
            let url = document.querySelector('#wsUrl').value;
            localStorage.setItem('ws_token', token);
            localStorage.setItem('ws_url', url);
            window.location.reload()
        }

        //flytta på element (source: w3schools tutorial)
        function dragElement(elem) {
            var diffX = 0, diffY = 0, mouseOrigX = 0, mouseOrigY = 0;
            //elem.onmousedown = dragMouseDown;
            dragMouseDown()

            function dragMouseDown(e) {
                console.log("func dragMouseDown")
                e = window.event;
                e.preventDefault();
                
                //musposition när man först trycker på noten
                mouseOrigX = e.clientX;
                mouseOrigY = e.clientY;
                
                //musläpp --> sluta
                document.onmouseup = closeDragElement;

                //Musflytt --> flytta på elementet
                document.onmousemove = elementDrag;
            }

            function elementDrag(evt) {
                console.log("func elementDrag")
                evt = evt || window.event;
                evt.preventDefault();
               
                //räkna skillnaden mellan föregående och nuvarande musposition
                diffX = mouseOrigX - evt.clientX;
                diffY = mouseOrigY - evt.clientY;
                mouseOrigX = evt.clientX;
                mouseOrigY = evt.clientY;

                //räkna nya positionen till elementet
                elem.style.top = (elem.offsetTop - diffY) + "px";
                elem.style.left = (elem.offsetLeft - diffX) + "px";

                //sicka härifrån note positionen till ws
                socket.send(JSON.stringify({
                    event: Events.Move,
                    elemId: elem.id, 
                    top: elem.style.top,
                    left: elem.style.left
                }))
            }

            function closeDragElement() {
                //sluta allt när musen släpps
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function editNote(elem){
            console.log("double click")
            elem.contentEditable = true
            elem.focus()
            //console.log(elem.id)
            elem.addEventListener('input', (evt) => {
                console.log(elem.innerText)
                socket.send(JSON.stringify({
                    event: Events.Content,
                    elemId: elem.id,
                    value: elem.innerText
                }));
           });
        }

        function addNote(elem){
            console.log("new note")
            //behöver dynamsikt hitta hur många notes de finns
            document.querySelector(".note-container").innerHTML += `<div id="note3" class="notes" onmousedown="dragElement(this)">
            <p id="content3" ondblclick="editNote(this)"></p> </div>`

            newNote = document.querySelector("#note3")

            newNote.style.top = '50%'
            newNote.style.left = '50%'
            newNote.style.transform = 'translate(50%, 50%)'

            socket.send(JSON.stringify({
                event: Events.Add,
                elemId: newNote.id,
                noteCount: 3
            }))

            editNote(document.querySelector("#content3"))
        }
        
       const socket = webSocket() //får man göra såhär
    </script>

</body>

</html>
